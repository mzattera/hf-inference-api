/*
 * HuggingFace NScale GenAI Services API
 * API for GenAI services: image generation, chat completions, embeddings
 *
 * The version of the OpenAPI document: 1.0.0
 * 
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */
package io.github.mzattera.hfinferenceapi.client.api;

import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.IOException;
import java.math.BigDecimal;
import java.util.ArrayList;
import java.util.Base64;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;

import javax.imageio.ImageIO;

import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.google.gson.Gson;

import io.github.mzattera.hfinferenceapi.ApiClient;
import io.github.mzattera.hfinferenceapi.ApiException;
import io.github.mzattera.hfinferenceapi.JSON;
import io.github.mzattera.hfinferenceapi.auth.Authentication;
import io.github.mzattera.hfinferenceapi.auth.HttpBearerAuth;
import io.github.mzattera.hfinferenceapi.client.model.AssistantMessage;
import io.github.mzattera.hfinferenceapi.client.model.ChatCompletionRequest;
import io.github.mzattera.hfinferenceapi.client.model.ChatCompletionResponse;
import io.github.mzattera.hfinferenceapi.client.model.EmbeddingData;
import io.github.mzattera.hfinferenceapi.client.model.EmbeddingsRequest;
import io.github.mzattera.hfinferenceapi.client.model.Function;
import io.github.mzattera.hfinferenceapi.client.model.FunctionTool;
import io.github.mzattera.hfinferenceapi.client.model.FunctionToolCall;
import io.github.mzattera.hfinferenceapi.client.model.ImageGenerationRequest;
import io.github.mzattera.hfinferenceapi.client.model.ImageGenerationRequestParameters;
import io.github.mzattera.hfinferenceapi.client.model.ImageGenerationResponseDataInner;
import io.github.mzattera.hfinferenceapi.client.model.JsonSchemaObject;
import io.github.mzattera.hfinferenceapi.client.model.JsonSchemaResponseFormat;
import io.github.mzattera.hfinferenceapi.client.model.Message;
import io.github.mzattera.hfinferenceapi.client.model.MessageContent;
import io.github.mzattera.hfinferenceapi.client.model.MessageContentPart;
import io.github.mzattera.hfinferenceapi.client.model.MessageContentPart.TypeEnum;
import io.github.mzattera.hfinferenceapi.client.model.TextContentPart;
import io.github.mzattera.hfinferenceapi.client.model.Tool;
import io.github.mzattera.hfinferenceapi.client.model.ToolMessage;
import io.github.mzattera.hfinferenceapi.client.model.UserMessage;
import okhttp3.OkHttpClient;
import okhttp3.logging.HttpLoggingInterceptor;

/**
 * API tests for DefaultApi
 */
public class DefaultApiTest {

//	private static String MODEL = "Qwen/Qwen2.5-VL-3B-Instruct";
	private static String MODEL = "openai/gpt-oss-120b";

	// The static field to hold the initialized API client
	private static DefaultApi api;

	/**
	 * Executes once before all tests to initialize the API client with the Bearer
	 * token and add an interceptor for logging requests and responses.
	 */
	@BeforeAll
	public static void init() {
		System.out.println("--- Executing @BeforeAll setup: Initializing API Client ---");

		// 1. Retrieve API Key from environment variable
		final String apiKey = System.getenv("HUGGING_FACE_API_KEY");
		if (apiKey == null || apiKey.trim().isEmpty()) {
			throw new IllegalStateException(
					"HUGGING_FACE_API_KEY environment variable is not set. Please set it before running tests.");
		}

		// 2. Initialize the base ApiClient
		ApiClient apiClient = new ApiClient();

		// --- START: Logging Interceptor Configuration ---
		// 2.1. Create the logging interceptor
		HttpLoggingInterceptor loggingInterceptor = new HttpLoggingInterceptor(System.out::println);

		// 2.2. Set the logging level to BODY. This level automatically includes the
		// Request Line
		// (Method and URL), Headers, and the complete Request/Response payload.
		loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY);

		// 2.3. Get the existing OkHttpClient builder, add the interceptor, and rebuild
		// the client.
		OkHttpClient.Builder httpClientBuilder = apiClient.getHttpClient().newBuilder()
				.addInterceptor(loggingInterceptor)
				// Optional: Configure timeouts for robust testing
				.connectTimeout(30, TimeUnit.SECONDS).readTimeout(60, TimeUnit.SECONDS);

		// 2.4. Set the new client on the ApiClient instance
		apiClient.setHttpClient(httpClientBuilder.build());
		System.out.println("HTTP Logging Interceptor configured (Level: BODY).");
		// --- END: Logging Interceptor Configuration ---

		// 3. Access and configure the Bearer authentication mechanism
		// The key 'bearerAuth' comes from your OpenAPI specification's security scheme
		// name.
		Map<String, Authentication> auths = apiClient.getAuthentications();
		Authentication bearerAuth = auths.get("bearerAuth");

		if (bearerAuth instanceof HttpBearerAuth) {
			HttpBearerAuth httpBearerAuth = (HttpBearerAuth) bearerAuth;

			// 4. Set the API Key as the Bearer Token
			httpBearerAuth.setBearerToken(apiKey);
			System.out.println("Bearer token successfully configured using HUGGING_FACE_API_KEY.");
		} else {
			System.err.println("Error: 'bearerAuth' authentication scheme not found or is not HttpBearerAuth.");
			throw new RuntimeException("API client authentication setup failed. Check your client generation.");
		}

		// 5. Initialize the DefaultApi service class using the configured ApiClient
		api = new DefaultApi(apiClient);

		System.out.println("API Client initialized and ready for testing.");
	}

	/**
	 * Chat Completion using messages
	 *
	 * @throws ApiException if the Api call fails
	 */
	@Test
	public void createChatCompletionTest() throws ApiException {

		Message msg;
		ChatCompletionRequest chatCompletionRequest;
		ChatCompletionResponse response;

		msg = new UserMessage().content(new MessageContent("Hi"));
		chatCompletionRequest = new ChatCompletionRequest().addMessagesItem(msg).model(MODEL);
		response = api.chatCompletion(chatCompletionRequest);
		System.out.println(response + "\n\n");
		System.out.println("Bot >\t" + response.getChoices().get(0).getMessage());

		List<MessageContentPart> msgs = new ArrayList<>();
		msgs.add(new TextContentPart().text("Hi").type(TypeEnum.TEXT));
		msgs.add(new TextContentPart().text("My name is Maxi; what is your name?").type(TypeEnum.TEXT));
		msg = new UserMessage().content(new MessageContent(msgs));
		chatCompletionRequest = new ChatCompletionRequest().addMessagesItem(msg).model(MODEL);
		response = api.chatCompletion(chatCompletionRequest);
		System.out.println("Bot >\t" + response.getChoices().get(0).getMessage());
	}

	/**
	 * Chat Completion - logprobs using messages
	 *
	 * @throws ApiException if the Api call fails
	 */
	@Test
	@Disabled
	public void logProbsTest() throws ApiException {

		Message msg;
		ChatCompletionRequest chatCompletionRequest;
		ChatCompletionResponse response;

		msg = new UserMessage().content(new MessageContent("Hi"));
		chatCompletionRequest = new ChatCompletionRequest().addMessagesItem(msg).model(MODEL).logprobs(true)
				.topP(BigDecimal.valueOf(0.8));
		response = api.chatCompletion(chatCompletionRequest);
		System.out.println(response + "\n\n");
		System.out.println("Bot >\t" + response.getChoices().get(0).getMessage());
	}

	/**
	 * Tool call in Chat Completion using messages
	 *
	 * @throws ApiException if the Api call fails
	 */
	@Test
	public void toolCallInChatCompletionTest() throws ApiException {

		List<Message> messages = new ArrayList<>();
		Message msg;
		ChatCompletionRequest chatCompletionRequest;
		ChatCompletionResponse response;

		// Arguments for our tool as JSON
		String arguments = "{\n" //
				+ "  \"$schema\" : \"http://json-schema.org/draft-04/schema#\",\n" //
				+ "  \"title\" : \"Parameters\",\n" //
				+ "  \"type\" : \"object\",\n" //
				+ "  \"additionalProperties\" : false,\n" //
				+ "  \"description\" : \"This is a class describing parameters for GetCurrentWeatherTool\",\n" //
				+ "  \"properties\" : {\n" //
				+ "    \"location\" : {\n" //
				+ "      \"type\" : \"string\",\n" //
				+ "      \"description\" : \"The city and state, e.g. San Francisco, CA.\"\n" //
				+ "    },\n" //
				+ "    \"unit\" : {\n" //
				+ "      \"type\" : \"string\",\n" //
				+ "      \"enum\" : [ \"CELSIUS\", \"FARENHEIT\" ],\n" //
				+ "      \"description\" : \"Temperature unit (CELSIUS or FARENHEIT), defaults to CELSIUS\"\n" //
				+ "    }\n" //
				+ "  },\n" //
				+ "  \"required\" : [ \"location\" ]\n" //
				+ "}";

		// Parse arguments into an object
		Gson gson = new Gson();
		Object parametersObject = null;
		parametersObject = gson.fromJson(arguments, Object.class);

		Function fun = new Function().name("GetCurrentWeatherTool")
				.description("Provides weather conditions in one city").parameters(parametersObject);
		Tool tool = new FunctionTool().function(fun).type(Tool.TypeEnum.FUNCTION);
		List<Tool> tools = new ArrayList<>();
		tools.add(tool);
		msg = new UserMessage().content(new MessageContent("What is the temperature in London (F)?"));
		messages.add(msg);
		chatCompletionRequest = new ChatCompletionRequest().messages(messages).tools(tools).model(MODEL);
		response = api.chatCompletion(chatCompletionRequest);

		AssistantMessage botMsg = (AssistantMessage) response.getChoices().get(0).getMessage();
		messages.add(botMsg);
		if (botMsg.getToolCalls().size() > 0) {
			// There was a tool call
			FunctionToolCall call = (FunctionToolCall) botMsg.getToolCalls().get(0); // only these are supported

			// Fake response
			msg = new ToolMessage().toolCallId(call.getId()).content(new MessageContent("35F"))
					.name(fun.getName());
			messages.add(msg);
			chatCompletionRequest = new ChatCompletionRequest().messages(messages).tools(tools).model(MODEL);
			response = api.chatCompletion(chatCompletionRequest);

			System.out.println(response + "\n\n");
			System.out.println("Bot >\t" + response.getChoices().get(0).getMessage());
		}
	}

	// Test response schema and logprobs then we should be fine

	/**
	 * Tests JSON schema response format.
	 *
	 * @throws ApiException            if the Api call fails
	 * @throws JsonProcessingException
	 */
	@Test
	public void jsonSchemaResponseTest() throws ApiException, JsonProcessingException {

		// Schema describing format of output Json
		String schema = "{\n" //
				+ "  \"$schema\" : \"http://json-schema.org/draft-04/schema#\",\n" //
				+ "  \"title\" : \"Person\",\n" //
				+ "  \"type\" : \"object\",\n" //
				+ "  \"properties\" : {\n" //
				+ "    \"fistName\" : {\n" //
				+ "      \"type\" : \"string\",\n" //
				+ "      \"description\" : \"The person first name.\"\n" //
				+ "    },\n" //
				+ "    \"lastName\" : {\n" //
				+ "      \"type\" : \"string\",\n" //
				+ "      \"description\" : \"The person last name.\"\n" //
				+ "    },\n" //
				+ "    \"age\" : {\n" //
				+ "      \"type\" : \"integer\",\n" //
				+ "      \"description\" : \"Person age\"\n" //
				+ "    }\n" //
				+ "  },\n" //
				+ "  \"required\" : [ \"fistName\", \"lastName\" ],\n" //
				+ "  \"additionalProperties\" : false\n" //
				+ "}";

		// Parse arguments into an object
		Gson gson = new Gson();
		Object schemaObj = null;
		schemaObj = gson.fromJson(schema, Object.class);

		JsonSchemaObject obj = new JsonSchemaObject().name("Person").description("Schema fro Person data")
				.schema(schemaObj);

		Message msg = new UserMessage().content( //
				new MessageContent(
						"Create 10 random person descriptions with first and last name and random age. Use the below schema for output:\n\n"
								+ schema));

		ChatCompletionRequest chatCompletionRequest = new ChatCompletionRequest().addMessagesItem(msg).model(MODEL);
		chatCompletionRequest.setResponseFormat(new JsonSchemaResponseFormat().jsonSchema(obj));

		ChatCompletionResponse response = api.chatCompletion(chatCompletionRequest);
		System.out.println(response + "\n\n");
		System.out.println("Bot >\t" + response.getChoices().get(0).getMessage());
	}

//	
//	Test image upload -> Qwen needs licenses

	/**
	 * Get embeddings for input(s)
	 *
	 * @throws ApiException if the Api call fails
	 */
	@Test
	public void createEmbeddingsTest() throws ApiException {
		List<String> inputs = new ArrayList<>();
		inputs.add("This is a test");
		inputs.add("And this is a test too");
		EmbeddingsRequest embeddingsRequest = new EmbeddingsRequest().input(inputs).model("Qwen/Qwen3-Embedding-8B");
		System.out.println("Request JSON: " + JSON.getGson().toJson(embeddingsRequest));

		for (EmbeddingData response : api.featureExtraction("nebius", embeddingsRequest).getData()) {
			System.out.println("Embedding vector size: " + response.getEmbedding().size());
			System.out.println("Embedding vector (first 10 values): " + response.getEmbedding().subList(0, 10));
		}
	}

	/**
	 * Text to Image generation
	 *
	 * @throws ApiException if the Api call fails
	 * @throws IOException
	 */
	@Test
	public void createImageTest() throws ApiException, IOException {

		ImageGenerationRequestParameters params = new ImageGenerationRequestParameters().width(512).height(512);
		ImageGenerationRequest imageGenerationRequest = new ImageGenerationRequest() //
				.model("stabilityai/stable-diffusion-xl-base-1.0") //
				.prompt("A red apple in space, photorealistic").parameters(params).n(1);

		int i = 0;
		for (ImageGenerationResponseDataInner d : api.textToImage("nscale", imageGenerationRequest).getData()) {
			BufferedImage image = null;
			try (ByteArrayInputStream bis = new ByteArrayInputStream(Base64.getDecoder().decode(d.getB64Json()))) {
				image = ImageIO.read(bis);
			}
			ImageIO.write(image, "png", new File("D:\\my_output_image" + (i++) + ".png"));
		}
	}
}
