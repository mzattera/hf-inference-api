/*
 * HuggingFace NScale GenAI Services API
 * API for GenAI services: image generation, chat completions, embeddings
 *
 * The version of the OpenAPI document: 1.0.0
 * 
 *
 * NOTE: This class is auto generated by OpenAPI Generator (https://openapi-generator.tech).
 * https://openapi-generator.tech
 * Do not edit the class manually.
 */

package io.github.mzattera.hfinferenceapi.client.api;

import java.awt.image.BufferedImage;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Base64;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;

import javax.imageio.ImageIO;

import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Disabled;
import org.junit.jupiter.api.Test;

import io.github.mzattera.hfinferenceapi.ApiClient;
import io.github.mzattera.hfinferenceapi.ApiException;
import io.github.mzattera.hfinferenceapi.JSON;
import io.github.mzattera.hfinferenceapi.auth.Authentication;
import io.github.mzattera.hfinferenceapi.auth.HttpBearerAuth;
import io.github.mzattera.hfinferenceapi.client.model.ChatCompletionRequest;
import io.github.mzattera.hfinferenceapi.client.model.ChatCompletionResponse;
import io.github.mzattera.hfinferenceapi.client.model.EmbeddingData;
import io.github.mzattera.hfinferenceapi.client.model.EmbeddingsRequest;
import io.github.mzattera.hfinferenceapi.client.model.ImageGenerationRequest;
import io.github.mzattera.hfinferenceapi.client.model.ImageGenerationRequestParameters;
import io.github.mzattera.hfinferenceapi.client.model.ImageGenerationResponseDataInner;
import io.github.mzattera.hfinferenceapi.client.model.Message;
import io.github.mzattera.hfinferenceapi.client.model.MessageContent;
import okhttp3.OkHttpClient;
import okhttp3.logging.HttpLoggingInterceptor;

/**
 * API tests for DefaultApi
 */
public class DefaultApiTest {

	// The static field to hold the initialized API client
	private static DefaultApi api;

	/**
	 * Executes once before all tests to initialize the API client with the Bearer
	 * token and add an interceptor for logging requests and responses.
	 */
	@BeforeAll
	public static void init() {
		System.out.println("--- Executing @BeforeAll setup: Initializing API Client ---");

		// 1. Retrieve API Key from environment variable
		final String apiKey = System.getenv("HUGGING_FACE_API_KEY");
		if (apiKey == null || apiKey.trim().isEmpty()) {
			throw new IllegalStateException(
					"HUGGING_FACE_API_KEY environment variable is not set. Please set it before running tests.");
		}

		// 2. Initialize the base ApiClient
		ApiClient apiClient = new ApiClient();

		// --- START: Logging Interceptor Configuration ---
		// 2.1. Create the logging interceptor
		HttpLoggingInterceptor loggingInterceptor = new HttpLoggingInterceptor(System.out::println);

		// 2.2. Set the logging level to BODY. This level automatically includes the
		// Request Line
		// (Method and URL), Headers, and the complete Request/Response payload.
		loggingInterceptor.setLevel(HttpLoggingInterceptor.Level.BODY);

		// 2.3. Get the existing OkHttpClient builder, add the interceptor, and rebuild
		// the client.
		OkHttpClient.Builder httpClientBuilder = apiClient.getHttpClient().newBuilder()
				.addInterceptor(loggingInterceptor)
				// Optional: Configure timeouts for robust testing
				.connectTimeout(30, TimeUnit.SECONDS).readTimeout(60, TimeUnit.SECONDS);

		// 2.4. Set the new client on the ApiClient instance
		apiClient.setHttpClient(httpClientBuilder.build());
		System.out.println("HTTP Logging Interceptor configured (Level: BODY).");
		// --- END: Logging Interceptor Configuration ---

		// 3. Access and configure the Bearer authentication mechanism
		// The key 'bearerAuth' comes from your OpenAPI specification's security scheme
		// name.
		Map<String, Authentication> auths = apiClient.getAuthentications();
		Authentication bearerAuth = auths.get("bearerAuth");

		if (bearerAuth instanceof HttpBearerAuth) {
			HttpBearerAuth httpBearerAuth = (HttpBearerAuth) bearerAuth;

			// 4. Set the API Key as the Bearer Token
			httpBearerAuth.setBearerToken(apiKey);
			System.out.println("Bearer token successfully configured using HUGGING_FACE_API_KEY.");
		} else {
			System.err.println("Error: 'bearerAuth' authentication scheme not found or is not HttpBearerAuth.");
			throw new RuntimeException("API client authentication setup failed. Check your client generation.");
		}

		// 5. Initialize the DefaultApi service class using the configured ApiClient
		api = new DefaultApi(apiClient);

		System.out.println("API Client initialized and ready for testing.");
	}

	/**
	 * Chat completion using messages
	 *
	 * @throws ApiException if the Api call fails
	 */
	@Test
	public void createChatCompletionTest() throws ApiException {
		ChatCompletionRequest chatCompletionRequest = new ChatCompletionRequest()
				.addMessagesItem(new Message().role("user").content(new MessageContent("Hi")))
				.model("openai/gpt-oss-120b");
		ChatCompletionResponse response = api.chatCompletion(chatCompletionRequest);
		System.out.println("Bot >\t" + response.getChoices().get(0).getMessage().getContent());
	}

	/**
	 * Get embeddings for input(s)
	 *
	 * @throws ApiException if the Api call fails
	 */
	@Test
	public void createEmbeddingsTest() throws ApiException {
		List<String> inputs = new ArrayList<>();
		inputs.add("This is a test");
		inputs.add("And this is a test too");
		EmbeddingsRequest embeddingsRequest = new EmbeddingsRequest().input(inputs).model("Qwen/Qwen3-Embedding-8B");
		System.out.println("Request JSON: " + JSON.getGson().toJson(embeddingsRequest));

		for (EmbeddingData response : api.featureExtraction("nebius", embeddingsRequest).getData()) {
			System.out.println("Embedding vector size: " + response.getEmbedding().size());
			System.out.println("Embedding vector (first 10 values): " + response.getEmbedding().subList(0, 10));
		}
	}

	/**
	 * Text to Image generation
	 *
	 * @throws ApiException if the Api call fails
	 * @throws IOException
	 */
	@Test
	public void createImageTest() throws ApiException, IOException {

		ImageGenerationRequestParameters params = new ImageGenerationRequestParameters().width(512).height(512);
		ImageGenerationRequest imageGenerationRequest = new ImageGenerationRequest() //
				.model("stabilityai/stable-diffusion-xl-base-1.0") //
				.prompt("A red apple in space, photorealistic").parameters(params).n(1);

		int i = 0;
		for (ImageGenerationResponseDataInner d : api.textToImage("nscale", imageGenerationRequest).getData()) {
			BufferedImage image = null;
			try (ByteArrayInputStream bis = new ByteArrayInputStream(Base64.getDecoder().decode(d.getB64Json()))) {
				image = ImageIO.read(bis);
			}
			ImageIO.write(image, "png", new File("D:\\my_output_image" + (i++) + ".png"));
		}
	}
}
